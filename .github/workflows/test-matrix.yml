# =============================================================================
# ComfyUI Custom Node Test Matrix
# =============================================================================
# Consumer repos call this workflow:
#   uses: PozzettiAndrea/comfy-test/.github/workflows/test-matrix.yml@main
# =============================================================================

name: ComfyUI Installation Test Matrix

on:
  workflow_call:
    inputs:
      config-file:
        description: "Path to comfy-test.toml config file"
        type: string
        default: "comfy-test.toml"
      timeout-minutes:
        description: "Job timeout in minutes"
        type: number
        default: 60
      run-gpu:
        description: "Run GPU tests (requires self-hosted runners)"
        type: boolean
        default: false

jobs:
  # ---------------------------------------------------------------------------
  # Setup: parse platform config
  # ---------------------------------------------------------------------------
  setup:
    runs-on: ubuntu-latest
    outputs:
      run-linux: ${{ steps.platforms.outputs.linux }}
      run-macos: ${{ steps.platforms.outputs.macos }}
      run-windows: ${{ steps.platforms.outputs.windows }}
      run-windows-portable: ${{ steps.platforms.outputs.windows-portable }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse platform config
        id: platforms
        run: |
          config="${{ inputs.config-file }}"
          get_platform() {
            [ -f "$config" ] && grep -E "^$1\s*=" "$config" 2>/dev/null | grep -qi "false" && echo "false" || echo "true"
          }
          echo "linux=$(get_platform linux)" >> $GITHUB_OUTPUT
          echo "macos=$(get_platform macos)" >> $GITHUB_OUTPUT
          echo "windows=$(get_platform windows)" >> $GITHUB_OUTPUT
          echo "windows-portable=$(get_platform windows_portable)" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # CPU tests (GitHub-hosted runners)
  # ---------------------------------------------------------------------------
  linux-cpu:
    needs: setup
    if: needs.setup.outputs.run-linux == 'true'
    uses: ./.github/workflows/_test-linux.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: false

  macos-cpu:
    needs: setup
    if: needs.setup.outputs.run-macos == 'true'
    uses: ./.github/workflows/_test-macos.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: false

  windows-cpu:
    needs: setup
    if: needs.setup.outputs.run-windows == 'true'
    uses: ./.github/workflows/_test-windows.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: false

  windows-portable-cpu:
    needs: setup
    if: needs.setup.outputs.run-windows-portable == 'true'
    uses: ./.github/workflows/_test-windows-portable.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: false

  # ---------------------------------------------------------------------------
  # GPU tests (self-hosted runners, optional)
  # ---------------------------------------------------------------------------
  linux-gpu:
    needs: setup
    if: inputs.run-gpu && needs.setup.outputs.run-linux == 'true'
    uses: ./.github/workflows/_test-linux.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: true

  macos-gpu:
    needs: setup
    if: inputs.run-gpu && needs.setup.outputs.run-macos == 'true'
    uses: ./.github/workflows/_test-macos.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: true

  windows-gpu:
    needs: setup
    if: inputs.run-gpu && needs.setup.outputs.run-windows == 'true'
    uses: ./.github/workflows/_test-windows.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: true

  windows-portable-gpu:
    needs: setup
    if: inputs.run-gpu && needs.setup.outputs.run-windows-portable == 'true'
    uses: ./.github/workflows/_test-windows-portable.yml
    with:
      config-file: ${{ inputs.config-file }}
      timeout-minutes: ${{ inputs.timeout-minutes }}
      gpu: true

  # ---------------------------------------------------------------------------
  # Publish results
  # ---------------------------------------------------------------------------
  publish:
    needs: [linux-cpu, macos-cpu, windows-cpu, windows-portable-cpu, linux-gpu, macos-gpu, windows-gpu, windows-portable-gpu]
    if: always()
    uses: ./.github/workflows/_publish-results.yml
